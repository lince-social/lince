[env]
RUST_CHANNEL = "nightly"
DOCS_ROOT = "documents"
FONT_PATH = "documents/font/IBM_Plex_Sans/static"

[tools]
rust = "{{env.RUST_CHANNEL}}"

[tasks.update]
description = "Update rustup and dependencies"
run = "rustup self update && rustup update {{env.RUST_CHANNEL}} && cargo upgrade"

[tasks.off]
description = "Auto-fix code and clippy warnings"
tools = { "cargo:mprocs" = "latest", "cargo:bacon" = "latest" }
run = """
cargo fix --broken-code --allow-dirty
cargo clippy --fix --allow-dirty --quiet >/dev/null 2>&1
"""

[tasks.run]
description = "Run with mprocs/bacon background jobs"
tools = { "cargo:mprocs" = "latest", "cargo:bacon" = "latest" }
run = 'mprocs "bacon . --job fix" "bacon . --job run"'

[tasks.service]
description = "Systemd service management + bacon + cargo run"
tools = { "cargo:mprocs" = "latest", "cargo:bacon" = "latest" }
run = """
mprocs \
"systemctl --user restart lince.service && journalctl --user -u lince.service -f --output=cat" \
"systemctl --user stop lince.service && journalctl --user -u lince.service -f --output=cat" \
"bacon . --job fix" \
"cargo run -- karma gui"
"""

[tasks.docs]
description = "Start typst documentation preview"
tools = { "tinymist" = "latest", "typst" = "latest" }
run = """
trap "typst compile --root . documents/content/documentation/main.typ" EXIT

tinymist preview \
--root . \
--control-plane-host 127.0.0.1:3002 \
--data-plane-host 127.0.0.1:3001 \
--static-file-host 127.0.0.1:3003 \
--font-path {{env.FONT_PATH}} \
--invert-colors='{"rest":"always", "image": "never"}' \
{{env.DOCS_ROOT}}/content/documentation/main.typ
"""

[tasks.tmil]
description = "This Month in Lince (Latest Month Preview)"
tools = { "tinymist" = "latest", "typst" = "latest" }
run = """
SEARCH_PATH="{{env.DOCS_ROOT}}/content/this_month_in_lince"
LATEST_DIR=$(ls -d $SEARCH_PATH/20*/ | sort -V | tail -n 1 | xargs basename)

echo "ðŸš€ Using latest data from: $LATEST_DIR"

# Cleanup/Compile on exit
trap "typst compile --root {{env.DOCS_ROOT}} --input dir=$LATEST_DIR $SEARCH_PATH/main.typ" EXIT
# Note: Ensure touying is in your path or added to tools if needed
trap "touying compile --root {{env.DOCS_ROOT}} --format html --input dir=$LATEST_DIR $SEARCH_PATH/main.typ" EXIT

tinymist preview \
  --root {{env.DOCS_ROOT}} \
  --control-plane-host 127.0.0.1:3002 \
  --data-plane-host 127.0.0.1:3001 \
  --static-file-host 127.0.0.1:3003 \
  --font-path {{env.FONT_PATH}} \
  --invert-colors='{"rest":"always", "image": "never"}' \
  --input dir=$LATEST_DIR \
  $SEARCH_PATH/main.typ
"""

[tasks.posts]
description = "Generate PNGs for social media posts"
tools = { "typst" = "latest" }
run = """
find {{env.DOCS_ROOT}}/content/social_media_posts -name '*.json' -type f | while read -r json; do
  rel="${json#{{env.DOCS_ROOT}}/content/social_media_posts/}"
  dir="$(dirname "$json")"
  base="$(basename "$json" .json)"
  typst compile --root ./ --format png --input json=\"$rel\" \
    {{env.DOCS_ROOT}}/content/social_media_posts/main.typ \
    \"$dir/${base}-{0p}.png\"
done
"""

[tasks.post]
description = "Preview social media posts"
tools = { "tinymist" = "latest" }
run = """
tinymist preview \
--root . \
--control-plane-host 127.0.0.1:3002 \
--data-plane-host 127.0.0.1:3001 \
--static-file-host 127.0.0.1:3003 \
--font-path {{env.FONT_PATH}} \
--invert-colors='{"rest":"always", "image": "never"}' \
{{env.DOCS_ROOT}}/content/social_media_posts/main.typ
"""

[tasks.release]
description = "Automated release workflow"
tools = { "cargo:git-cliff" = "latest", "cargo:cargo-edit" = "latest", "gh" = "latest" }
run = """
set -e
[[ $(git rev-parse --abbrev-ref HEAD) != "main" ]] && echo "âŒ main only" && exit 1
gh auth status >/dev/null || { echo "ðŸ”‘ login required"; exit 1; }

SUGGESTED_VER=$(git cliff --bumped-version 2>/dev/null || echo "0.1.0")
read -rp "Version (auto: $SUGGESTED_VER): " USER_INPUT
VERSION=${USER_INPUT:-$SUGGESTED_VER}
[[ $VERSION != v* ]] && VERSION="v$VERSION"

git cliff --unreleased --bump --tag "$VERSION" -o CHANGELOG.md
cargo set-version "${VERSION#v}"
git add . && git commit -m "chore(release): $VERSION" && git tag -a "$VERSION" -m "$VERSION"
git push origin main "$VERSION"
gh run list --workflow=build-release --limit 1 --json url -q '.[0].url'
"""

[tasks.cross]
description = "Cross-build using cross-rs"
tools = { "cargo:cross" = "latest" }
run = "docker pull ghcr.io/cross-rs/x86_64-unknown-linux-gnu:main --platform linux/x86_64 && cross build --target x86_64-unknown-linux-gnu --release"
