[env]
RUST_CHANNEL = "nightly"
DOCS_ROOT = "documents"
FONT_PATH = "documents/font/IBM_Plex_Sans/static"

[tools]
rust = "{{env.RUST_CHANNEL}}"

[tasks.update]
description = "Update rustup and dependencies"
run = "rustup self update && rustup update {{env.RUST_CHANNEL}} && cargo upgrade"

[tasks.off]
description = "Auto-fix code and clippy warnings"
tools = { "cargo:mprocs" = "latest", "cargo:bacon" = "latest" }
run = """
cargo fix --broken-code --allow-dirty
cargo clippy --fix --allow-dirty --quiet >/dev/null 2>&1
"""

[tasks.dev]
description = "Run with mprocs/bacon background jobs"
tools = { "cargo:mprocs" = "latest", "cargo:bacon" = "latest" }
run = 'mprocs "bacon . --job fix" "bacon . --job run"'

[tasks.service]
description = "Systemd service management + bacon + cargo run"
tools = { "cargo:mprocs" = "latest", "cargo:bacon" = "latest" }
run = """
mprocs \
"systemctl --user restart lince.service && journalctl --user -u lince.service -f --output=cat" \
"systemctl --user stop lince.service && journalctl --user -u lince.service -f --output=cat" \
"bacon . --job fix" \
"cargo run -- karma gui"
"""

[tasks.migrate]
description = "Create a reversible SQL migration"
tools = {"cargo:sqlx-cli" = "latest"}
usage = "arg '<name>' help='The name of the migration'"
run = """
echo Creating migration: $usage_name
sqlx migrate add -r $usage_name
echo Created migration: $usage_name
"""


[tasks.docs]
description = "Start typst documentation preview"
tools = { "tinymist" = "latest", "typst" = "latest" }
usage = """
flag "-l --light" help="Use light mode in tinymist preview (default: dark)"
flag "-L --light-only" help="Only compile light version (default: compiles both)"
flag "-D --dark-only" help="Only compile dark version (default: compiles both)"
"""
run = """
LIGHT_ONLY="${usage_light_only:-false}"
DARK_ONLY="${usage_dark_only:-false}"

# Default to dark mode, use light if --light flag is passed
if [ "${usage_light:-false}" = "true" ]; then
  PREVIEW_DARK="false"
else
  PREVIEW_DARK="true"
fi

compile_docs() {
  echo 'Compiling PDF versions, might take a while...'
  if [ "$LIGHT_ONLY" = "true" ]; then
    echo '  â†’ Compiling light version...'
    typst compile --root . --input dark=false documents/content/documentation/main.typ documents/content/documentation/main-light.pdf
  elif [ "$DARK_ONLY" = "true" ]; then
    echo '  â†’ Compiling dark version...'
    typst compile --root . --input dark=true documents/content/documentation/main.typ documents/content/documentation/main-dark.pdf
  else
    echo '  â†’ Compiling light version...'
    typst compile --root . --input dark=false documents/content/documentation/main.typ documents/content/documentation/main-light.pdf
    echo '  â†’ Compiling dark version...'
    typst compile --root . --input dark=true documents/content/documentation/main.typ documents/content/documentation/main-dark.pdf
  fi
  echo 'Done!'
}

trap compile_docs EXIT

tinymist preview \
--root . \
--control-plane-host 127.0.0.1:3002 \
--data-plane-host 127.0.0.1:3001 \
--static-file-host 127.0.0.1:3003 \
--input dark=$PREVIEW_DARK \
{{env.DOCS_ROOT}}/content/documentation/main.typ
"""

[tasks.tmil]
description = "This Month in Lince (Latest Month Preview)"
tools = { "tinymist" = "latest", "typst" = "latest", "pipx:touying" = "latest" }
run = """
SEARCH_PATH="{{env.DOCS_ROOT}}/content/this_month_in_lince"
DEFAULT_DIR="2025_12"
ACTIVE_YEAR=$(find "$SEARCH_PATH" -mindepth 1 -maxdepth 1 -type d -name '20*' -printf '%f\\n' | sort -V | tail -n 1)
LATEST_DIR=""
if [ -n "$ACTIVE_YEAR" ]; then
  LATEST_DIR=$(find "$SEARCH_PATH/$ACTIVE_YEAR" -mindepth 1 -maxdepth 1 -type f -name "${ACTIVE_YEAR}_*.json" -printf '%f\\n' | sed 's/\\.json$//' | sort -V | tail -n 1)
fi
if [ -z "$LATEST_DIR" ]; then
  LATEST_DIR="$DEFAULT_DIR"
fi
SYS_INPUTS=$(printf '{"dir":"%s"}' "$LATEST_DIR")

echo "ðŸš€ Using latest data from: $LATEST_DIR"

trap 'touying compile --root . --format html --sys-inputs "$SYS_INPUTS" "$SEARCH_PATH/main.typ"' EXIT

tinymist preview \
  --root . \
  --control-plane-host 127.0.0.1:3002 \
  --data-plane-host 127.0.0.1:3001 \
  --static-file-host 127.0.0.1:3003 \
  --font-path {{env.FONT_PATH}} \
  --input dir=$LATEST_DIR \
  $SEARCH_PATH/main.typ
"""

[tasks.release]
description = "Automated release workflow"
tools = { "cargo:git-cliff" = "latest", "cargo:cargo-edit" = "latest", "gh" = "latest" }
run = """
set -e
[[ $(git rev-parse --abbrev-ref HEAD) != "main" ]] && echo "âŒ main only" && exit 1
gh auth status >/dev/null || { echo "ðŸ”‘ login required"; exit 1; }

SUGGESTED_VER=$(git cliff --bumped-version 2>/dev/null || echo "0.1.0")
read -rp "Version (auto: $SUGGESTED_VER): " USER_INPUT
VERSION=${USER_INPUT:-$SUGGESTED_VER}
[[ $VERSION != v* ]] && VERSION="v$VERSION"

git cliff --unreleased --bump --tag "$VERSION" -o CHANGELOG.md
cargo set-version "${VERSION#v}"
git add . && git commit -m "chore(release): $VERSION" && git tag -a "$VERSION" -m "$VERSION"
git push origin main "$VERSION"
gh run list --workflow=build-release --limit 1 --json url -q '.[0].url'
"""

[tasks.cross]
description = "Cross-build using cross-rs"
tools = { "cargo:cross" = "latest" }
run = "docker pull ghcr.io/cross-rs/x86_64-unknown-linux-gnu:main --platform linux/x86_64 && cross build --target x86_64-unknown-linux-gnu --release"
